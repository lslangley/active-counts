<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
	<title>ARC Bike Counts</title>
	<script src="bower_components/jquery/dist/jquery.min.js"></script>
	<script src="bower_components/tabletop/src/tabletop.js"></script>
	<script src="bower_components/sheetsee/js/sheetsee.js"></script>
	<script src="bower_components/moment/min/moment.min.js"></script>
	<script src="bower_components/d3/d3.min.js"></script>
	<script src="http://code.highcharts.com/highcharts.js"></script>
	<script src="http://code.highcharts.com/modules/exporting.js"></script>
	<script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.9/mapbox.js'></script>
	<link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.9/mapbox.css' rel='stylesheet' />
	<link rel="stylesheet" type="text/css" href="bower_components/weather-icons/css/weather-icons.min.css">
	<style type="text/css">
		#map, #shapesmap {max-width: 800px; height: 500px;}
	    .leaflet-popup-content li {list-style:none;}
	    .leaflet-popup-content {width: 102px;}
	    .leaflet-popup-content img {width: 100px;}
	    a {border: none;}
	</style>
</head>
<body>
<p>
	<em><a href="https://docs.google.com/spreadsheets/d/1eKo4ssv5EKQRS25qfeXQqIJOjoiJ_-Cg1krMylsEIdI/edit?usp=sharing" target="_blank">spreadsheet</a></em>
	<i class="wi wi-day-lightning"></i>
	<i class="wi wi-night-alt-snow"></i>
<p>

<div id="map"></div>
<select multiple id="dates"></select>
<button id="submit-dates">submit</button>
<button id="clear-dates">clear</button>
<div id="weather"></div>
<div id="container"></div>
<script type="text/javascript">
	var locations, counts;
	var weatherData = [];
	var counters;
	// Provide your access token
	L.mapbox.accessToken = 'pk.eyJ1IjoiYXRscmVnaW9uYWwiLCJhIjoiQmZ6d2tyMCJ9.oENm3NSf--qHrimdm9Vvdw';
	// Create a map in the div #map
	var map = L.mapbox.map('map', 'atlregional.tm2-basemap');

	// https://docs.google.com/spreadsheets/d/1eKo4ssv5EKQRS25qfeXQqIJOjoiJ_-Cg1krMylsEIdI/edit?usp=sharing
	document.addEventListener('DOMContentLoaded', function() {
        var URL = "1eKo4ssv5EKQRS25qfeXQqIJOjoiJ_-Cg1krMylsEIdI"
        Tabletop.init( { key: URL, callback: showInfo } )
        // Tabletop.init( { key: URL2, callback: shapesMap, simpleSheet: true } )
        $('#submit-dates').on('click', function(e){
        	var dateValues = $('#dates').val();
        	console.log(dateValues);
        	var visibleStations = [];
        	for (var i = dateValues.length - 1; i >= 0; i--) {
        		// var existingStations = visibleStations;
        		console.log(visibleStations)
        		console.log(dateValues[i])
        		console.log(Object.keys(countsDates[dateValues[i]]))
        		visibleStations.push.apply(visibleStations, Object.keys(countsDates[dateValues[i]]))
        		// visibleStations = $.merge(Object.keys(countsDates[dateValues[i]]), visibleStations);
        		// console.log(Object.keys(countsDates[dateValues[i]]))
        		// console.log(counters.getLayers())
        		var layers = counters.getLayers()
        		for (var j = layers.length - 1; j >= 0; j--) {
        			// console.log(layers[i].feature.opts.StationID);
        			var id = layers[j].feature.opts.StationID;
        			if (visibleStations.indexOf(id) === -1){
        				layers[j].setStyle({fill: false, stroke: false});
        			}
        			else{
        				layers[j].setStyle({fill: true, stroke: true});
        				layers[j].setRadius(getCount(layers[j].feature, dateValues[i])/10, dateValues[i]);
        			}

        		};
        		// if (Object.keys(countsDates[dateValues[i]])){

        		// }
        	} // end for dateValues
        	console.log(visibleStations);

        }) // end submit click
		$('#clear-dates').on('click', function(e){
			var layers = counters.getLayers()
        	for (var j = layers.length - 1; j >= 0; j--) {
        		layers[j].setStyle({fill: true, stroke: true});
        		layers[j].setRadius(10);
        	}
		});
      }) // end DOMContentLoaded
	function getCount(feature, date){
		var total = 0
		var countData = countsDates[date][feature.opts.StationID];
		console.log(countData);
		for (var i = 0; i < countData.length; i++) {
			var sum = 0;
			for (var key in countData[i]) {
			// for (var j = countData.length - 1; i >= 0; i--) {
			// 	countData[i]
			// };
			    if (countData[i].hasOwnProperty(key)) {
			        // console.log(key)
			        if (/CntIinterval/g.test(key)){
			        	sum += +countData[i][key];
			        }
			    }
			}
			total += sum;
		}
		return total;
	}
	function getStationData(e){
		$('#weather').empty();
		var count = e.target.feature;
		var id = e.target.feature.opts.StationID;
		var content = [];
		var dates = [];
		var total = 0;
		var totals = [];
		var countData = counts[id];
		for (var i = 0; i < countData.length; i++) {

			console.log(countData[i]);
			var date = countData[i].Date;

			total = getCount(count, date);
			
			var minutes = countData[i].CntStartTime.substr(countData[i].CntStartTime.length - 2)
			var hours = countData[i].CntStartTime.length === 4 ? countData[i].CntStartTime.substr(0,2) : countData[i].CntStartTime.substr(0, 1);
			var dateTime = moment(date + ' ' + hours + ':' + minutes, "YYYYMMDD H:mm");
			console.log(dateTime.format());
			console.log(minutes);
			console.log(e.target.feature);
			if (i === 0){
				$('#weather').append('<h4>' + countData[i].Description + '</h4>');
			}
			else if (i === countData.length - 1){
				// $('#weather').append('<p>'+date+' count: ' + total + '</p>');
			}
			content.push(dateTime.format("dddd, MMMM Do YYYY, h:mm:ss a"));
			console.log(content);
			
			if (!(dates.indexOf(date) > -1) ){
				// Get weather for unique days
				// $.getJSON('http://api.wunderground.com/api/4fa8163ffde1665b/history_'+date+'/q/GA/Atlanta.json', function(data){
				// 	console.log(date)
				// 	weatherData.push(data);
				// 	console.log(data.history.dailysummary[0]);
				// 	var weather = data.history.dailysummary[0];
				// 	var maxTemp = weather.maxtempi;
				// 	var minTemp = weather.mintempi;
				// 	var precip = weather.precipi;
				// 	var wind = weather.wspdi;
				// 	var snow = weather.snow;
				// 	var thunder = weather.thunder;
				// 	console.log(i);
				// 	$('#weather').append(formatWeather(weather));
				// })

				// Only add date/total count is it's a new value
				dates.push(date);
				totals.push(total);
			}
			
			console.log(dates);
			// var svg = d3.select("body").append("svg").attr("width", 100).attr("height", 100);

			// var rect = svg.append("rect").attr("x", 40).attr("y", 40).attr("height", total).attr("width", 10);

			// rect.on("click", function() {
			//     console.log("rect");
			// });
			// svg.on("click", function() { console.log("svg"); });
		};
		console.log(total);
		drawChart(totals, dates);
		

	}
	function formatWeather(weather){
		var weatherString = weather.date.pretty.split(' on ')[1] + '<br />';
		if (+weather.thunder){
			weatherString += '<i class="wi wi-lightning"></i>'
		}
		else if (+weather.snow) {
			weatherString += '<i class="wi wi-snow"></i>'
		}
		else if (+weather.rain) {
			weatherString += '<i class="wi wi-rain"></i>'
		}
		else if (+weather.maxwspdi > 24){
			weatherString += '<i class="wi wi-cloudy-gusts"></i>'
		}
		else {
			weatherString += '<i class="wi wi-day-sunny"></i>'
		}
		return 	weatherString + 
				'<p>hi: ' + weather.maxtempi + '</p><p>low: ' + weather.mintempi + '</p>' +
				'<p><small>weather data from <a href="http://www.wunderground.com/?apiref=4f22d8b6220c8d33">wunderground</a></small></p>'
	}

	function drawChart(totals, dates){
		$(function () {
		    $('#container').highcharts({
		        chart: {
		            zoomType: 'xy'
		        },
		        title: {
		            text: 'Average Monthly Weather Data for Tokyo'
		        },
		        subtitle: {
		            text: 'Source: WorldClimate.com'
		        },
		        xAxis: [{
		            categories: dates,
		            crosshair: true
		        }],
		        yAxis: [{ // Primary yAxis
		            labels: {
		                format: '{value}°C',
		                style: {
		                    color: Highcharts.getOptions().colors[2]
		                }
		            },
		            title: {
		                text: 'Temperature',
		                style: {
		                    color: Highcharts.getOptions().colors[2]
		                }
		            },
		            opposite: true

		        }, { // Secondary yAxis
		            gridLineWidth: 0,
		            title: {
		                text: 'Count',
		                style: {
		                    color: Highcharts.getOptions().colors[0]
		                }
		            },
		            labels: {
		                format: '{value} cyclists',
		                style: {
		                    color: Highcharts.getOptions().colors[0]
		                }
		            }

		        }, { // Tertiary yAxis
		            gridLineWidth: 0,
		            title: {
		                text: 'Sea-Level Pressure',
		                style: {
		                    color: Highcharts.getOptions().colors[1]
		                }
		            },
		            labels: {
		                format: '{value} mb',
		                style: {
		                    color: Highcharts.getOptions().colors[1]
		                }
		            },
		            opposite: true
		        }],
		        tooltip: {
		            shared: true
		        },
		        legend: {
		            layout: 'vertical',
		            align: 'left',
		            x: 80,
		            verticalAlign: 'top',
		            y: 55,
		            floating: true,
		            backgroundColor: (Highcharts.theme && Highcharts.theme.legendBackgroundColor) || '#FFFFFF'
		        },
		        series: [{
		            name: 'Count',
		            type: 'column',
		            yAxis: 1,
		            data: totals,
		            tooltip: {
		                valueSuffix: ' cyclists'
		            }

		        }, {
		            name: 'Sea-Level Pressure',
		            type: 'spline',
		            yAxis: 2,
		            data: [1016, 1016, 1015.9, 1015.5, 1012.3, 1009.5, 1009.6, 1010.2, 1013.1, 1016.9, 1018.2, 1016.7],
		            marker: {
		                enabled: false
		            },
		            dashStyle: 'shortdot',
		            tooltip: {
		                valueSuffix: ' mb'
		            }

		        }, {
		            name: 'Temperature',
		            type: 'spline',
		            data: [7.0, 6.9, 9.5, 14.5, 18.2, 21.5, 25.2, 26.5, 23.3, 18.3, 13.9, 9.6],
		            tooltip: {
		                valueSuffix: ' °C'
		            }
		        }]
		    });
		});


	}
	function showInfo(data) {
		console.log(data);
		locations = data.Locations;
		counts = d3.nest()
    		.key(function(d) { return d.StationID; })
    		.map(data.Counts.elements);
    	countsDates = d3.nest()
    		.key(function(d) { return d.Date; })
    		.key(function(d) { return d.StationID; })
    		.map(data.Counts.elements);
    	countIntervals = d3.nest()
    		.key(function(d) { return d.StationID; })
    		.key(function(d) { return d.CntInterval; })
    		.map(data.Counts.elements);
    	console.log(countsDates);
    	var dates = Object.keys(countsDates).sort();
    	for (var i = 0; i < dates.length; i++) {
    		$('#dates').append('<option>' + dates[i] + '</option>');
    	};
		var optionsJSON = ["Description", "Technology", "CntIinterval1", "YrCount","MoCount","DayCount"]
		var template = "<ul>"
		             + "<li>{{Technology}}</li>"
		             + "<li>Count = {{CntIinterval1}}</li>"
		             + "<li><h4>{{Description}}</h4></li></ul>";
		// var geo = createGeoJSON(data, optionsJSON);
		// for (var i = data.length - 1; i >= 0; i--) {
		// 	console.log(data[i]);
		// };
		var geoJSON = Sheetsee.createGeoJSON(locations.elements);
		console.log(geoJSON);
		// var marker = L.marker([33, -86]).addTo(map);
		var stations = [];
		counters = L.geoJson(geoJSON, {
			pointToLayer: function(feature, latlng) {
		        return L.circleMarker(latlng, {
		            // Here we use the `count` property in GeoJSON verbatim: if it's
		            // to small or two large, we can use basic math in Javascript to
		            // adjust it so that it fits the map better.
		            radius: 10
		        })
		    },
			onEachFeature: function(feature, layer){
				layer.bindPopup("<strong>StationID:</strong> " + feature.opts.StationID
					// +"<br />"
		   //           + "Count = "+feature.opts.CntIinterval1+"<br />"
		   //           + "<strong>"+feature.opts.Description+"</strong>"
		        );
				layer.on({
					click: getStationData
				});
				stations.push(feature.opts.StationID);
			}
		}).addTo(map);
		console.log(counters);
		map.fitBounds(counters.getBounds());
		// var map = Sheetsee.loadMap("map")
		// Sheetsee.addTileLayer(map, 'mapbox.streets')
		// Sheetsee.addMarkerLayer(geoJSON, map, template)

		// http://api.wunderground.com/api/4fa8163ffde1665b/history_20060405/q/GA/Atlanta.json
	}
</script>
</body>

</html>